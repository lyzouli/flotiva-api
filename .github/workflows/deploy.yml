name: Deploy to Production

on:
  push:
    branches: ["main"]        # déploie à chaque push sur main
  workflow_dispatch:          # déclenchement manuel possible

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # (Checkout pas strictement nécessaire ici, on déploie via SSH)
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Ces variables sont déjà créées en "Actions secrets"
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}         # ex: /var/www/flotiva-api
          PHP_CMD: ${{ secrets.PHP_CMD }}                 # ex: /usr/bin/php8.3
          COMPOSER_BIN: ${{ secrets.COMPOSER_BIN }}       # ex: /usr/bin/composer
          GIT_BRANCH: ${{ secrets.GIT_BRANCH }}           # (optionnel) sinon défaut "main" dans le script
          PHP_FPM_SERVICE: ${{ secrets.PHP_FPM_SERVICE }} # (optionnel) ex: php8.3-fpm
        with:
          host: ${{ secrets.SSH_HOST }}                   # ex: 203.0.113.10
          username: ${{ secrets.SSH_USER }}               # ex: deploy
          port: ${{ secrets.SSH_PORT }}                   # ex: 22
          key: ${{ secrets.SSH_KEY }}                     # clé PRIVÉE OpenSSH
          script_stop: true
          command_timeout: "20m"
          debug: true
          # IMPORTANT : on forward uniquement les NOMS, pas les valeurs
          envs: REMOTE_PATH,PHP_CMD,COMPOSER_BIN,GIT_BRANCH,PHP_FPM_SERVICE
          script: |
            set -euo pipefail
            umask 002

            # ---------- Config & defaults ----------
            : "${REMOTE_PATH:?REMOTE_PATH secret requis}"
            PHP_CMD="${PHP_CMD:-php}"
            COMPOSER_BIN="${COMPOSER_BIN:-composer}"
            GIT_BRANCH="${GIT_BRANCH:-main}"
            PHP_FPM_SERVICE="${PHP_FPM_SERVICE:-php-fpm}"

            echo "➡️  Cibles:"
            echo "  - path:  ${REMOTE_PATH}"
            echo "  - php:   ${PHP_CMD}"
            echo "  - comp:  ${COMPOSER_BIN}"
            echo "  - branch:${GIT_BRANCH}"
            echo "  - fpm:   ${PHP_FPM_SERVICE}"

            # ---------- Git : fetch/reset propre ----------
            cd -- "${REMOTE_PATH}"
            echo "➡️  whoami=$(whoami)  pwd=$(pwd)"

            git config --global --add safe.directory "${REMOTE_PATH}" || true

            # éviter le prompt host key de github.com (premier run)
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            if ! grep -q "github.com" ~/.ssh/known_hosts 2>/dev/null; then
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            fi
            chmod 600 ~/.ssh/known_hosts || true

            echo "➡️  Fetch/reset sur ${GIT_BRANCH}"
            set -x
            git fetch --prune origin
            git checkout -B "${GIT_BRANCH}" "origin/${GIT_BRANCH}"
            git reset --hard "origin/${GIT_BRANCH}"
            set +x

            # ---------- Maintenance ON ----------
            echo "➡️  Maintenance ON"
            ${PHP_CMD} artisan down --render="errors::503" || true

            # ---------- Composer install (packages & autoload) ----------
            echo "➡️  Composer install (prod)"
            ${COMPOSER_BIN} install --no-dev --prefer-dist --no-interaction --optimize-autoloader

            # ---------- Migrations DB ----------
            echo "➡️  Migrate --force"
            ${PHP_CMD} artisan migrate --force

            # ---------- Caches ----------
            echo "➡️  Clear caches"
            ${PHP_CMD} artisan config:clear || true
            ${PHP_CMD} artisan route:clear  || true
            ${PHP_CMD} artisan view:clear   || true

            echo "➡️  Rebuild caches"
            ${PHP_CMD} artisan config:cache
            ${PHP_CMD} artisan route:cache
            ${PHP_CMD} artisan view:cache

            # ---------- Liens & queues ----------
            echo "➡️  Storage link & queues"
            ${PHP_CMD} artisan storage:link      || true
            ${PHP_CMD} artisan queue:restart     || true
            ${PHP_CMD} artisan horizon:terminate || true  # si Horizon est utilisé

            # ---------- Permissions minimales ----------
            echo "➡️  Fix permissions"
            mkdir -p storage/framework/{cache,views,sessions}
            chgrp -R www-data storage bootstrap/cache || true
            chmod -R ug+rwx storage bootstrap/cache   || true

            # ---------- Maintenance OFF ----------
            echo "➡️  Maintenance OFF"
            ${PHP_CMD} artisan up

            # ---------- Reload PHP-FPM ----------
            echo "➡️  Reload PHP-FPM"
            sudo -n systemctl reload "${PHP_FPM_SERVICE}" || true

            echo "✅ Déploiement terminé"
